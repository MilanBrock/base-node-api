name: "LLM Code Review"

on:
  pull_request:
    paths-ignore:
      - "*.md"
      - "LICENSE"

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: "Checkout code"
        uses: actions/checkout@v3
        with:
          # Fetch minimal history since we don't need the full repository
          fetch-depth: 1

      - name: "Get diff of the pull request"
        id: get_diff
        shell: bash
        run: |-
          # Download the pull request diff using the diff_url
          curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3.diff" \
            ${{ github.event.pull_request.url }} > diff_raw.txt

          # Exclude binary files (e.g., images) from diff
          grep -vE 'diff --git a/.*\.(png|jpg|jpeg|gif|pdf)$' diff_raw.txt > diff.txt

          # Output the diff to GitHub Actions output
          echo "pull_request_diff<<EOF" >> $GITHUB_OUTPUT
          cat diff.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: "Code Review"
        uses: ./codeReview
        id: review
        with:
          apiKey: ${{ secrets.OPENAI_API_KEY }}
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          githubRepository: ${{ github.repository }}
          githubPullRequestNumber: ${{ github.event.pull_request.number }}
          gitCommitHash: ${{ github.event.pull_request.head.sha }}
          model: "gpt-4o-mini"
          temperature: "0.1"
          maxTokens: "1000"
          pullRequestDiff: ${{ steps.get_diff.outputs.pull_request_diff }}
          pullRequestChunkSize: "3500"
          logLevel: "DEBUG"
