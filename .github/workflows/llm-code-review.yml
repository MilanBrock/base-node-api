name: "LLM Code Review"

on:
  pull_request:
    paths-ignore:
      - "*.md"
      - "LICENSE"

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: "Checkout PR Head"
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch all commits in the pull request
          ref: refs/pull/${{ github.event.pull_request.number }}/head

      - name: "Fetch Base Branch"
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }} --depth=1

      - name: "Generate Diff with Increased Context"
        id: get_diff
        shell: bash
        run: |
          # Generate the diff with increased context lines  (amount of lines above & under the change). This is the number after "-U"
          git diff -U10 origin/${{ github.event.pull_request.base.ref }} HEAD \
            -- . ':(exclude)*.png' ':(exclude)*.jpg' ':(exclude)*.jpeg' ':(exclude)*.gif' ':(exclude)*.pdf' > diff.txt

          # Output the diff to GitHub Actions output
          echo "pull_request_diff<<EOF" >> $GITHUB_OUTPUT
          cat diff.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: "Code Review"
        uses: ./codeReview
        id: review
        with:
          apiKey: ${{ secrets.OPENAI_API_KEY }}
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          githubRepository: ${{ github.repository }}
          githubPullRequestNumber: ${{ github.event.pull_request.number }}
          gitCommitHash: ${{ github.event.pull_request.head.sha }}
          model: "gpt-4o-mini"
          pullRequestDiff: ${{ steps.get_diff.outputs.pull_request_diff }}
          pullRequestChunkSize: "3500"
          logLevel: "DEBUG"
